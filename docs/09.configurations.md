# Configuration Guide

Complete reference for all configuration options in ecewo.

## Table of Contents

- [Arena Memory Management](#arena-memory-management)
- [Server Limits](#server-limits)
- [HTTP Parser Limits](#http-parser-limits)
- [Routing](#routing)
- [Middleware](#middleware)
- [Example Configuration](#configuration)
- [Debugging Configuration Issues](#debugging-configuration-issues)

---

## Arena Memory Management

Controls memory allocation behavior for request/response handling.

### `ARENA_REGION_SIZE`
- **Default**: `65536` (64 KB)
- **Location**: `src/arena.h`
- **Description**: Size of each arena memory region. Larger values reduce allocations but increase memory per request.

### `ARENA_POOL_SIZE`
- **Default**: `1024`
- **Location**: `src/arena-pool.c`
- **Description**: Maximum number of arenas in the pool. Hard limit on concurrent requests.

### `PREALLOCATED_ARENA`
- **Default**: `32`
- **Location**: `src/arena-pool.c`
- **Environment Variable**: `ECEWO_ARENA_PREALLOC`
- **Description**: Number of arenas pre-allocated at startup. Reduces allocation overhead during initial load.

### `ARENA_POOL_LOW_WATERMARK`
- **Default**: `8`
- **Location**: `src/arena-pool.c`
- **Description**: When available arenas drop below this, pool grows by `ARENA_POOL_GROW_BATCH`.

### `ARENA_POOL_HIGH_WATERMARK`
- **Default**: `64`
- **Location**: `src/arena-pool.c`
- **Description**: When available arenas exceed this, pool shrinks to conserve memory.

### `ARENA_POOL_GROW_BATCH`
- **Default**: `8`
- **Location**: `src/arena-pool.c`
- **Description**: Number of arenas allocated at once when growing.

---

## Server Limits

Controls connection handling and timeouts.

### `MAX_CONNECTIONS`
- **Default**: `10000`
- **Location**: `src/server.c`
- **Description**: Maximum concurrent client connections. New connections rejected when limit reached.

### `LISTEN_BACKLOG`
- **Default**: `511`
- **Location**: `src/server.c`
- **Description**: TCP listen backlog queue size. Pending connections before accept.

### `READ_BUFFER_SIZE`
- **Default**: `16384` (16 KB)
- **Location**: `src/server.h`
- **Description**: Size of per-connection read buffer. Must fit typical request in one read for best performance.

### `IDLE_TIMEOUT_MS`
- **Default**: `60000` (60 seconds)
- **Location**: `src/server.c`
- **Description**: Keep-alive connection timeout. Idle connections closed after this period.

### `REQUEST_TIMEOUT_MS`
- **Default**: `30000` (30 seconds)
- **Location**: `src/server.c`
- **Description**: Maximum time to receive complete request. Prevents slowloris attacks.

### `CLEANUP_INTERVAL_MS`
- **Default**: `30000` (30 seconds)
- **Location**: `src/server.c`
- **Description**: How often to scan for idle connections to close.

### `SHUTDOWN_TIMEOUT_MS`
- **Default**: `15000` (15 seconds)
- **Location**: `src/server.c`
- **Description**: Maximum time to wait for graceful shutdown before forcing.

### `CLEANUP_TIMEOUT_MS`
- **Default**: `5000` (5 seconds)
- **Location**: `src/server.c`
- **Description**: Timeout for final cleanup operations during shutdown.

---

## HTTP Parser Limits

Controls HTTP parsing behavior and security limits.

### `MIN_BUFFER_SIZE`
- **Default**: `64`
- **Location**: `src/http.c`
- **Description**: Minimum buffer size for dynamic HTTP parsing buffers.

### `GROWTH_FACTOR`
- **Default**: `1.5`
- **Location**: `src/http.c`
- **Description**: Buffer growth multiplier when reallocating.

### `MAX_SINGLE_ALLOCATION`
- **Default**: `10485760` (10 MB)
- **Location**: `src/http.c`
- **Description**: Maximum single buffer allocation size.

### `ABSOLUTE_MAX_REQUEST`
- **Default**: `52428800` (50 MB)
- **Location**: `src/http.c`
- **Description**: Hard limit on total request size. Prevents memory exhaustion attacks.

### `MAX_HEADER_SIZE`
- **Default**: `8192` (8 KB)
- **Location**: `src/http.c`
- **Description**: Maximum size for single HTTP header field or value.

### `MAX_URL_LENGTH`
- **Default**: `2048`
- **Location**: `src/http.c`
- **Description**: Maximum URL length including query string.

### `MAX_METHOD_LENGTH`
- **Default**: `16`
- **Location**: `src/http.c`
- **Description**: Maximum HTTP method name length (GET, POST, etc).

### `MAX_HEADERS_COUNT`
- **Default**: `100`
- **Location**: `src/http.c`
- **Description**: Maximum number of HTTP headers per request.

### `MAX_QUERY_PARAMS`
- **Default**: `100`
- **Location**: `src/http.c`
- **Description**: Maximum number of query parameters in URL.

---

## Routing

Controls URL routing and parameter extraction.

### `MAX_PATH_SEGMENTS`
- **Default**: `128`
- **Location**: `src/route-trie.h`
- **Description**: Maximum depth of URL path (number of `/` separated segments).
- **Example**: `/api/v1/users/123/posts/456` = 6 segments

### `MAX_INLINE_PARAMS`
- **Default**: `8`
- **Location**: `src/route-trie.h`
- **Description**: Number of URL parameters stored on stack before heap allocation.
- **Example**: `/users/:id/posts/:postId/comments/:commentId` = 3 params

---

## Middleware

Controls middleware chain behavior.

### `INITIAL_MW_CAPACITY`
- **Default**: `8`
- **Location**: `src/middleware.h`
- **Description**: Initial capacity for global middleware array.

---

## Example Configuration

```shell
# In your CMakeLists.txt
target_compile_definitions(my_app PRIVATE
  # Arena tuning
  PREALLOCATED_ARENA=64
  ARENA_REGION_SIZE=131072
  ARENA_POOL_SIZE=2048
  
  # Connection limits
  MAX_CONNECTIONS=5000
  READ_BUFFER_SIZE=32768
  
  # Timeouts
  IDLE_TIMEOUT_MS=45000
  REQUEST_TIMEOUT_MS=20000
  
  # HTTP limits
  MAX_HEADERS_COUNT=150
  ABSOLUTE_MAX_REQUEST=104857600  # 100 MB
)

target_link_libraries(my_app ecewo)
```

---

## Debugging Configuration Issues

### Too many arenas allocated
```
Arena pool grew: +8 arenas (now 256/1024 available)
```
**Solution**: Increase `PREALLOCATED_ARENA`

### Arena pool exhausted
```
Arena pool exhausted! (max 1024 reached)
```
**Solution**: Increase `ARENA_POOL_SIZE` or reduce `MAX_CONNECTIONS`

### Request size exceeded
```
HTTP parsing failed: size limits exceeded - Request payload exceeds maximum size
```
**Solution**: Increase `ABSOLUTE_MAX_REQUEST`

### Too many headers
```
HTTP parsing failed: size limits exceeded - Too many HTTP headers
```
**Solution**: Increase `MAX_HEADERS_COUNT`

### Connection timeout
```
Request timeout - closing connection
```
**Solution**: Increase `REQUEST_TIMEOUT_MS` or optimize slow handlers

### Connection refused
```
Connection error: EMFILE (too many open files)
```
**Solution**: Increase system file descriptor limits:
```bash
ulimit -n 65535
# Or permanently in /etc/security/limits.conf
```
